<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌟 Math Stars Challenge 🌟</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow-x: hidden;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            max-width: 900px;
            width: 100%;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        /* Laptop/Desktop (wider layout) */
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            
            .container {
                padding: 30px;
                border-radius: 30px;
            }
            
            h1 {
                font-size: 2.5em;
                margin-bottom: 25px;
            }
            
            .difficulty-buttons {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .difficulty-btn {
                min-width: auto;
            }
        }

        /* Large Desktop */
        @media (min-width: 1200px) {
            .difficulty-buttons {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .loading {
            text-align: center;
            color: #667eea;
            font-size: 1.2em;
            padding: 20px;
        }

        .user-section {
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .user-section {
                margin-bottom: 30px;
            }
        }

        .user-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        input[type="text"], input[type="number"] {
            flex: 1;
            padding: 12px;
            border: 3px solid #667eea;
            border-radius: 12px;
            font-size: 1em;
            font-family: 'Comic Sans MS', cursive;
        }

        @media (min-width: 768px) {
            input[type="text"], input[type="number"] {
                padding: 15px;
                border-radius: 15px;
                font-size: 1.1em;
            }
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-family: 'Comic Sans MS', cursive;
        }

        @media (min-width: 768px) {
            button {
                padding: 15px 30px;
                border-radius: 15px;
                font-size: 1.1em;
            }
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f, #a8e063);
            color: white;
        }

        .difficulty-section {
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .difficulty-section {
                margin-bottom: 30px;
            }
        }

        .difficulty-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .difficulty-btn {
            flex: 1;
            min-width: 150px;
            background: #f0f0f0;
            color: #333;
            padding: 15px;
        }

        .difficulty-btn.active {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        .game-section {
            text-align: center;
        }

        .problem {
            font-size: 2.5em;
            color: #667eea;
            margin: 20px 0;
            font-weight: bold;
        }

        @media (min-width: 768px) {
            .problem {
                font-size: 3.5em;
                margin: 30px 0;
            }
        }

        .answer-input {
            width: 100%;
            padding: 20px;
            border: 3px solid #667eea;
            border-radius: 15px;
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 20px;
            font-family: 'Comic Sans MS', cursive;
        }

        .progress {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 20px;
        }

        .results {
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            padding: 30px;
            border-radius: 20px;
            margin-top: 20px;
        }

        .results h2 {
            color: #d63031;
            margin-bottom: 20px;
        }

        .score {
            font-size: 1.5em;
            color: #00b894;
            margin: 15px 0;
        }

        @media (min-width: 768px) {
            .score {
                font-size: 2em;
                margin: 20px 0;
            }
        }

        .stats {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 2px solid #eee;
        }

        .hidden {
            display: none;
        }

        .emoji {
            font-size: 2.5em;
            margin: 15px 0;
        }

        @media (min-width: 768px) {
            .emoji {
                font-size: 3em;
                margin: 20px 0;
            }
        }

        .user-stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
        }

        .rating {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 1.3em;
            font-weight: bold;
        }

        .wrong-answers {
            background: #fff3cd;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: left;
        }

        .wrong-answers h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .wrong-item {
            padding: 10px;
            background: white;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }

        .history-section, .standings-section {
            max-height: 60vh;
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            .history-section, .standings-section {
                max-height: 70vh;
            }
        }

        .history-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }

        .history-item h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .top-menu {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 15px 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .menu-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .menu-btn:hover {
            background: white;
            color: #667eea;
        }

        .logout-btn {
            background: rgba(255, 59, 48, 0.8);
            border-color: #ff3b30;
        }

        .logout-btn:hover {
            background: #ff3b30;
            color: white;
        }

        .current-user {
            color: white;
            font-weight: bold;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            flex-grow: 1;
            text-align: center;
        }

        .standings-podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .podium-item {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 15px;
            min-width: 150px;
        }

        .podium-1 {
            order: 2;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            transform: scale(1.1);
        }

        .podium-2 {
            order: 1;
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
        }

        .podium-3 {
            order: 3;
            background: linear-gradient(135deg, #cd7f32, #e6a96a);
        }

        .podium-rank {
            font-size: 2em;
            margin-bottom: 8px;
        }

        @media (min-width: 768px) {
            .podium-rank {
                font-size: 3em;
                margin-bottom: 10px;
            }
        }

        .podium-name {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 5px;
        }

        .podium-score {
            color: #666;
        }

        .standings-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
        }

        .standing-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid #667eea;
        }

        .standing-item.current-user-standing {
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            border-left-color: #ff6b6b;
        }

        .standing-rank {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            min-width: 50px;
        }

        .standing-info {
            flex-grow: 1;
        }

        .standing-name {
            font-weight: bold;
            font-size: 1.1em;
        }

        .standing-tests {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            <h2>🚀 Loading Math Stars...</h2>
            <p>Connecting to server...</p>
        </div>

        <div id="mainApp" class="hidden">
            <div id="topMenu" class="top-menu hidden">
                <button class="menu-btn" onclick="goHome()">🏠 Home</button>
                <button class="menu-btn" onclick="showStandings()">🏆 Standings</button>
                <div class="current-user" id="currentUserDisplay"></div>
                <button class="menu-btn logout-btn" onclick="logout()">🚪 Logout</button>
            </div>
            
            <h1>🌟 Math Stars Challenge 🌟</h1>
            
            <div id="userSection" class="user-section">
                <div class="user-input">
                    <input type="text" id="userName" placeholder="Enter your name">
                    <button class="btn-primary" onclick="startGame()">Start Game! 🚀</button>
                </div>
                <div id="userStats" class="user-stats hidden"></div>
                <button id="historyBtn" class="btn-primary hidden" onclick="showHistory()" style="margin-top: 10px; width: 100%;">View Test History 📊</button>
            </div>

            <div id="operationSection" class="difficulty-section hidden">
                <h2 style="color: #667eea; margin-bottom: 15px;">Choose Operation:</h2>
                <div class="difficulty-buttons">
                    <button class="difficulty-btn" onclick="setOperation('addition')">Addition ➕</button>
                    <button class="difficulty-btn" onclick="setOperation('subtraction')">Subtraction ➖</button>
                    <button class="difficulty-btn" onclick="setOperation('multiplication')">Multiplication ✖️</button>
                    <button class="difficulty-btn" onclick="setOperation('division')">Division ➗</button>
                </div>
            </div>

            <div id="difficultySection" class="difficulty-section hidden">
                <h2 style="color: #667eea; margin-bottom: 15px;">Choose Your Level:</h2>
                <div class="difficulty-buttons">
                    <button class="difficulty-btn" onclick="setDifficulty('1digit')">1 Digit<br>⭐</button>
                    <button class="difficulty-btn" onclick="setDifficulty('2digit')">2 Digits<br>⭐⭐</button>
                    <button class="difficulty-btn" onclick="setDifficulty('3digit')">3 Digits<br>⭐⭐⭐</button>
                </div>
            </div>

            <div id="gameSection" class="game-section hidden">
                <div class="progress" id="progress">Question 1 of 10</div>
                <div class="problem" id="problem">5 × 3 = ?</div>
                <input type="number" class="answer-input" id="answer" placeholder="Type your answer">
                <button class="btn-success" onclick="checkAnswer()">Submit Answer ✓</button>
            </div>

            <div id="resultsSection" class="results hidden">
                <h2>Great Job! 🎉</h2>
                <div class="emoji" id="resultEmoji">🌟</div>
                <div class="score" id="score">You got 8/10 correct!</div>
                <div id="rating" class="rating"></div>
                <div class="stats">
                    <div class="stat-item">
                        <span>Correct Answers:</span>
                        <span id="correct">8</span>
                    </div>
                    <div class="stat-item">
                        <span>Wrong Answers:</span>
                        <span id="wrong">2</span>
                    </div>
                    <div class="stat-item">
                        <span>Last 5 Tests Average:</span>
                        <span id="average">85%</span>
                    </div>
                </div>
                <div id="wrongAnswers" class="wrong-answers"></div>
                <button class="btn-primary" onclick="playAgain()" style="margin-top: 20px;">Play Again! 🔄</button>
            </div>

            <div id="historySection" class="history-section hidden">
                <h2 style="color: #667eea; margin-bottom: 20px;">📊 Test History</h2>
                <div id="historyList"></div>
                <button class="btn-primary" onclick="closeHistory()" style="margin-top: 20px;">Back to Game</button>
            </div>

            <div id="standingsSection" class="standings-section hidden">
                <h2 style="color: #667eea; margin-bottom: 20px;">🏆 Leaderboard</h2>
                <div id="standingsPodium" class="standings-podium"></div>
                <div id="standingsList" class="standings-list"></div>
                <button class="btn-primary" onclick="closeStandings()" style="margin-top: 20px;">Back to Game</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, getDoc, setDoc, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCXIyKCeJaxafBFqLTACG_MTBIAwEE5Gj8",
            authDomain: "kidtools-e31ab.firebaseapp.com",
            projectId: "kidtools-e31ab",
            storageBucket: "kidtools-e31ab.firebasestorage.app",
            messagingSenderId: "832171289169",
            appId: "1:832171289169:web:f000cb63e587409bc0a670",
            measurementId: "G-JMFQQKDT55"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = '';
        let operation = '';
        let difficulty = '';
        let currentQuestion = 0;
        let correctAnswers = 0;
        let currentNum1, currentNum2, currentAnswer;
        let wrongAnswers = [];
        let users = {};

        async function loadUsers() {
            try {
                const usersCollection = collection(db, 'users');
                const snapshot = await getDocs(usersCollection);
                users = {};
                snapshot.forEach(doc => {
                    users[doc.id] = doc.data();
                });
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('loading').innerHTML = '<h2>⚠️ Connection Error</h2><p>Please check your internet connection and refresh the page.</p>';
            }
        }

        async function saveUser(userData) {
            try {
                await setDoc(doc(db, 'users', userData.name), userData);
                users[userData.name] = userData;
            } catch (error) {
                console.error('Error saving user:', error);
                alert('Error saving data. Please check your connection.');
            }
        }

        window.startGame = async function() {
            const name = document.getElementById('userName').value.trim();
            if (!name) {
                alert('Please enter your name! 😊');
                return;
            }

            currentUser = name;
            
            if (!users[currentUser]) {
                users[currentUser] = {
                    name: currentUser,
                    tests: []
                };
                await saveUser(users[currentUser]);
            }

            const statsDiv = document.getElementById('userStats');
            const testCount = users[currentUser].tests.length;
            const last5Avg = calculateLast5Average();
            statsDiv.innerHTML = `<strong>Welcome back, ${currentUser}! 👋</strong><br>Tests completed: ${testCount} | Last 5 Average: ${last5Avg}%`;
            statsDiv.classList.remove('hidden');

            document.getElementById('userSection').querySelector('.user-input').classList.add('hidden');
            document.getElementById('historyBtn').classList.remove('hidden');
            
            document.getElementById('topMenu').classList.remove('hidden');
            document.getElementById('currentUserDisplay').textContent = `👤 ${currentUser}`;
            
            document.getElementById('operationSection').classList.remove('hidden');
        }

        window.setOperation = function(op) {
            operation = op;
            document.querySelectorAll('#operationSection .difficulty-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('operationSection').classList.add('hidden');
            document.getElementById('difficultySection').classList.remove('hidden');
        }

        window.setDifficulty = function(level) {
            difficulty = level;
            document.querySelectorAll('#difficultySection .difficulty-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            currentQuestion = 0;
            correctAnswers = 0;
            wrongAnswers = [];
            
            document.getElementById('difficultySection').classList.add('hidden');
            document.getElementById('gameSection').classList.remove('hidden');
            
            generateProblem();
        }

        function generateProblem() {
            let num1, num2;
            
            if (difficulty === '1digit') {
                num1 = Math.floor(Math.random() * 9) + 1;
                num2 = Math.floor(Math.random() * 9) + 1;
            } else if (difficulty === '2digit') {
                num1 = Math.floor(Math.random() * 90) + 10;
                num2 = Math.floor(Math.random() * 9) + 1;
            } else {
                num1 = Math.floor(Math.random() * 900) + 100;
                num2 = Math.floor(Math.random() * 9) + 1;
            }

            if (operation === 'subtraction' && num1 < num2) {
                [num1, num2] = [num2, num1];
            }

            if (operation === 'division') {
                currentAnswer = num2;
                num1 = num2 * (Math.floor(Math.random() * 9) + 1);
                num2 = Math.floor(num1 / currentAnswer);
                num1 = num2 * currentAnswer;
            }

            currentNum1 = num1;
            currentNum2 = num2;

            let symbol = '';
            if (operation === 'addition') {
                currentAnswer = num1 + num2;
                symbol = '+';
            } else if (operation === 'subtraction') {
                currentAnswer = num1 - num2;
                symbol = '-';
            } else if (operation === 'multiplication') {
                currentAnswer = num1 * num2;
                symbol = '×';
            } else if (operation === 'division') {
                currentAnswer = Math.floor(num1 / num2);
                symbol = '÷';
            }

            document.getElementById('problem').textContent = `${num1} ${symbol} ${num2} = ?`;
            document.getElementById('answer').value = '';
            document.getElementById('answer').focus();
        }

        window.checkAnswer = function() {
            const userAnswer = parseInt(document.getElementById('answer').value);
            
            if (isNaN(userAnswer)) {
                alert('Please enter a number! 🔢');
                return;
            }

            if (userAnswer === currentAnswer) {
                correctAnswers++;
            } else {
                let symbol = operation === 'addition' ? '+' : operation === 'subtraction' ? '-' : operation === 'multiplication' ? '×' : '÷';
                wrongAnswers.push({
                    problem: `${currentNum1} ${symbol} ${currentNum2}`,
                    userAnswer: userAnswer,
                    correctAnswer: currentAnswer
                });
            }

            currentQuestion++;

            if (currentQuestion < 10) {
                document.getElementById('progress').textContent = `Question ${currentQuestion + 1} of 10`;
                generateProblem();
            } else {
                showResults();
            }
        }

        function calculateLast5Average() {
            if (!users[currentUser] || users[currentUser].tests.length === 0) return 0;
            const last5 = users[currentUser].tests.slice(-5);
            const sum = last5.reduce((acc, test) => acc + test.percentage, 0);
            return Math.round(sum / last5.length);
        }

        function getRating(avg) {
            if (avg >= 90) return { text: '🏆 Math Champion!', emoji: '🏆', color: '#ffd700' };
            if (avg >= 80) return { text: '⭐ Excellent Student!', emoji: '⭐', color: '#4CAF50' };
            if (avg >= 70) return { text: '👍 Good Work!', emoji: '👍', color: '#2196F3' };
            if (avg >= 60) return { text: '💪 Keep Practicing!', emoji: '💪', color: '#FF9800' };
            return { text: '📚 Study More!', emoji: '📚', color: '#F44336' };
        }

        async function showResults() {
            const percentage = (correctAnswers / 10) * 100;
            const timestamp = new Date().toLocaleString();
            
            const testResult = {
                operation: operation,
                difficulty: difficulty,
                correct: correctAnswers,
                wrong: 10 - correctAnswers,
                percentage: percentage,
                timestamp: timestamp,
                wrongAnswers: [...wrongAnswers]
            };
            
            users[currentUser].tests.push(testResult);
            await saveUser(users[currentUser]);

            const last5Avg = calculateLast5Average();
            const rating = getRating(last5Avg);

            document.getElementById('gameSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            
            document.getElementById('score').textContent = `You got ${correctAnswers}/10 correct!`;
            document.getElementById('correct').textContent = correctAnswers;
            document.getElementById('wrong').textContent = 10 - correctAnswers;
            document.getElementById('average').textContent = last5Avg + '%';

            const ratingDiv = document.getElementById('rating');
            ratingDiv.innerHTML = `${rating.emoji} ${rating.text}`;
            ratingDiv.style.background = `linear-gradient(135deg, ${rating.color}, ${rating.color}dd)`;

            const emoji = percentage >= 80 ? '🏆' : percentage >= 60 ? '⭐' : '💪';
            document.getElementById('resultEmoji').textContent = emoji;

            const wrongDiv = document.getElementById('wrongAnswers');
            if (wrongAnswers.length > 0) {
                wrongDiv.innerHTML = '<h3>Review Your Mistakes:</h3>';
                wrongAnswers.forEach(item => {
                    wrongDiv.innerHTML += `
                        <div class="wrong-item">
                            <strong>${item.problem} = ${item.correctAnswer}</strong><br>
                            Your answer: ${item.userAnswer}
                        </div>
                    `;
                });
            } else {
                wrongDiv.innerHTML = '<h3 style="color: #28a745;">Perfect! No mistakes! 🎉</h3>';
            }
        }

        window.showHistory = function() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            if (users[currentUser].tests.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #666;">No tests completed yet!</p>';
            } else {
                users[currentUser].tests.slice().reverse().forEach((test, index) => {
                    const actualIndex = users[currentUser].tests.length - index;
                    historyList.innerHTML += `
                        <div class="history-item">
                            <h4>Test #${actualIndex} - ${test.operation.charAt(0).toUpperCase() + test.operation.slice(1)} (${test.difficulty})</h4>
                            <p><strong>Date:</strong> ${test.timestamp}</p>
                            <p><strong>Score:</strong> ${test.correct}/10 (${test.percentage}%)</p>
                            ${test.wrongAnswers.length > 0 ? `
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; color: #667eea;">View Mistakes</summary>
                                    <div style="margin-top: 10px;">
                                        ${test.wrongAnswers.map(wa => `
                                            <div style="padding: 5px; background: #f8f9fa; margin: 5px 0; border-radius: 5px;">
                                                ${wa.problem} = ${wa.correctAnswer} (You answered: ${wa.userAnswer})
                                            </div>
                                        `).join('')}
                                    </div>
                                </details>
                            ` : '<p style="color: #28a745;">✓ Perfect score!</p>'}
                        </div>
                    `;
                });
            }

            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('userSection').classList.add('hidden');
            document.getElementById('historySection').classList.remove('hidden');
        }

        window.closeHistory = function() {
            document.getElementById('historySection').classList.add('hidden');
            document.getElementById('userSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
        }

        window.goHome = function() {
            document.getElementById('operationSection').classList.add('hidden');
            document.getElementById('difficultySection').classList.add('hidden');
            document.getElementById('gameSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('historySection').classList.add('hidden');
            document.getElementById('standingsSection').classList.add('hidden');
            
            document.getElementById('userSection').classList.remove('hidden');
            document.getElementById('userSection').querySelector('.user-input').classList.add('hidden');
            document.getElementById('historyBtn').classList.remove('hidden');
            document.getElementById('operationSection').classList.remove('hidden');
        }

        window.showStandings = async function() {
            await loadUsers();
            
            const standings = Object.values(users)
                .filter(user => user.tests && user.tests.length > 0)
                .map(user => {
                    const last5 = user.tests.slice(-5);
                    const avg = Math.round(last5.reduce((acc, test) => acc + test.percentage, 0) / last5.length);
                    return {
                        name: user.name,
                        average: avg,
                        totalTests: user.tests.length
                    };
                })
                .sort((a, b) => b.average - a.average);

            const podiumDiv = document.getElementById('standingsPodium');
            podiumDiv.innerHTML = '';
            
            if (standings.length >= 1) {
                const medals = ['🥇', '🥈', '🥉'];
                const classes = ['podium-1', 'podium-2', 'podium-3'];
                
                standings.slice(0, 3).forEach((user, index) => {
                    podiumDiv.innerHTML += `
                        <div class="podium-item ${classes[index]}">
                            <div class="podium-rank">${medals[index]}</div>
                            <div class="podium-name">${user.name}</div>
                            <div class="podium-score">${user.average}% avg</div>
                        </div>
                    `;
                });
            }

            const listDiv = document.getElementById('standingsList');
            listDiv.innerHTML = '<h3 style="color: #667eea; margin-bottom: 15px;">All Students</h3>';
            
            if (standings.length === 0) {
                listDiv.innerHTML += '<p style="text-align: center; color: #666;">No students have completed tests yet!</p>';
            } else {
                standings.forEach((user, index) => {
                    const isCurrentUser = user.name === currentUser;
                    listDiv.innerHTML += `
                        <div class="standing-item ${isCurrentUser ? 'current-user-standing' : ''}">
                            <div class="standing-rank">#${index + 1}</div>
                            <div class="standing-info">
                                <div class="standing-name">${user.name} ${isCurrentUser ? '(You)' : ''}</div>
                                <div class="standing-tests">${user.totalTests} tests • ${user.average}% average</div>
                            </div>
                            <div class="standing-rank">${user.average}%</div>
                        </div>
                    `;
                });
            }

            document.getElementById('operationSection').classList.add('hidden');
            document.getElementById('difficultySection').classList.add('hidden');
            document.getElementById('gameSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('historySection').classList.add('hidden');
            document.getElementById('userSection').classList.add('hidden');
            
            document.getElementById('standingsSection').classList.remove('hidden');
        }

        window.closeStandings = function() {
            document.getElementById('standingsSection').classList.add('hidden');
            goHome();
        }

        window.logout = function() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = '';
                
                document.getElementById('topMenu').classList.add('hidden');
                
                document.getElementById('operationSection').classList.add('hidden');
                document.getElementById('difficultySection').classList.add('hidden');
                document.getElementById('gameSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.add('hidden');
                document.getElementById('historySection').classList.add('hidden');
                document.getElementById('standingsSection').classList.add('hidden');
                document.getElementById('userStats').classList.add('hidden');
                document.getElementById('historyBtn').classList.add('hidden');
                
                document.getElementById('userSection').classList.remove('hidden');
                document.getElementById('userSection').querySelector('.user-input').classList.remove('hidden');
                document.getElementById('userName').value = '';
            }
        }

        window.playAgain = function() {
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('operationSection').classList.remove('hidden');
        }

        document.getElementById('answer')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkAnswer();
        });

        document.getElementById('userName')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') startGame();
        });

        loadUsers();
    </script>
</body>
</html>